<!DOCTYPE html>
<meta charset="utf-8">
<script src="http://d3js.org/d3.v2.min.js?2.9.3"></script>
<script src="https://d3js.org/d3-collection.v1.min.js"></script>
<script src="https://d3js.org/d3-array.v1.min.js"></script>
<script src="http://chancejs.com/chance.min.js"></script>
<script src="https://d3js.org/d3-timer.v1.min.js"></script>
<script src="http://localhost:35729/livereload.js"></script>
<script src="graph.js"></script>
<script src="display_utils.js"></script>
<script src="guys.js"></script>
<script src="shortest_path.js"></script>
<script src="shortcuts.js"></script>
<script src="keyhandlers.js"></script>
<style>

circle {
	stroke: none;
}

circle.guy {
	fill: #f0f;
	transform: scale(2);
}

circle.exit {
	fill: #0f0;
	transform: scale(1);
}
line {
	stroke: black;
}
</style>
<body>
<svg width="600" height="600" ></svg>
<script>
// var node_colors = {empty: "#000", exit: "#0f0", guy: "#f0f", seed: "#ff0", soft_obstacle: "#0ff", highlighted: "#f00"};

var lastSelected = null;


// global constants
var svg = d3.select("svg")

var nodes = make_graph(Number(svg.attr('width')), Number(svg.attr('height')), 2);
console.log(nodes)
// TODO: write higher level point framework
var row_groups = svg.selectAll("g")  
	.data(nodes) 
      .enter()
      .append("g")

row_groups.attr('transform', d => d.offset_for_row())
/*
I'm trying to do the state updating. The problem is that it is not entirely local, we need to see if a space is occupied.
so there is global state.
*/

function node_label(d) {
	return `(${d.index.join(',')}): ${d.distance}`
}

row_groups.selectAll('g')
	.data(d => d.nodes_in_rows)
	.enter()
	.append('g')
	.attr('transform', d => d.offset_within_row() )

row_groups.selectAll("g")
     .append("text")
     .attr("dx", 12)
     .attr("dy", "2em")
     .text(node_label)


row_gruops.selectAll("g")
      .append("circle")
	.attr("r", d => d.radius)
      .attr("class", function(d) { return d.node_type; })

var simulation_history = [];
d3.select(window).on('keydown', function() {
	d3.event.preventDefault();
	
	//console.log(d3.event.keyCode)

	if (d3.event.keyCode == 39) { // right arrow 
		if (has_guys_away_from_exit()) {
			simulation_history.push(move_guys_to_exit());
		}

	}
	if (d3.event.keyCode == 37) { // left arrow 

		if (simulation_history.length > 0) {
			var types = simulation_history.pop();

			d3.selectAll("g").each((d, i) => d.node_type = types[i]);
			d3.selectAll("g circle").attr('class', d => d.node_type);
		}
	}
	if (d3.event.keyCode == 69) { // 'e' is the delete key

		if (lastSelected) {
			delete_node(lastSelected.datum())
			lastSelected = null;
		}			
	}
})

d3.select('svg').on('click', function(d) {
	var click_point = d3.mouse(this);
	
	console.log(click_point)
})
d3.selectAll('circle').on('click', function(d) { 
	console.log('clicked')
	var new_type = d.node_type == 'empty' ? 'guy' : 'empty';
	d.node_type = new_type; 
	d3.select(this).attr('class', new_type);	

	lastSelected = d3.select(this);
})

// demo stuff

</script>
</body>
