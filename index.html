<!DOCTYPE html>
<meta charset="utf-8">
<script src="http://d3js.org/d3.v2.min.js?2.9.3"></script>
<script src="https://d3js.org/d3-collection.v1.min.js"></script>
<script src="https://d3js.org/d3-array.v1.min.js"></script>
<script src="http://chancejs.com/chance.min.js"></script>
<script src="https://d3js.org/d3-timer.v1.min.js"></script>
<script src="http://localhost:35729/livereload.js"></script>
<script src="graph.js"></script>
<script src="display_utils.js"></script>
<script src="guys.js"></script>
<script src="shortest_path.js"></script>
<script src="shortcuts.js"></script>
<script src="keyhandlers.js"></script>
<style>

circle {
	stroke: none;
}

.deleted circle {
	fill: white;
	stroke: grey;
	stroke-dasharray: 4;
	transform: scale(1);
}
.empty circle {
	fill: black;
	transform: scale(1);
}
.deleted text {
	fill: grey;
}

.guy text {
	fill: black;
}
.empty text {
	fill: black;
}
.exit text {
	fill: black;
}
.guy circle {
	fill: #f0f;
	transform: scale(2);
}

.exit circle {
	fill: #0f0;
	transform: scale(1);
}
line {
	stroke: black;
}
</style>
<body>
<svg width="600" height="600" ></svg>
<script>
// var node_colors = {empty: "#000", exit: "#0f0", guy: "#f0f", seed: "#ff0", soft_obstacle: "#0ff", highlighted: "#f00"};

var lastSelected = null;


// global constants
var svg = d3.select("svg")

var node_data = make_graph(Number(svg.attr('width')), Number(svg.attr('height')), 6);

var row_groups = svg.selectAll("g")  
	.data(node_data) 
      .enter()
      .append("g")

row_groups.attr('transform', d => d.offset_for_row())

// initialize the nodes
row_groups.selectAll('g')
	.data(d => d.nodes_in_row)
	.enter()
	.append('g')
	.attr('transform', d => d.offset_within_row() )

n('*').append("text")
     .attr("dx", 12)
     .attr("dy", "2em")

n('*').append("circle")
     .attr("r", d => d.radius)
     .attr("cx", 0)
     .attr("cy", 0)

nd('0,0').distance = 0;
nd('0,0').node_type = 'exit';

function update_shortest_paths() {
	compute_shortest_path_distances(nd('*'));

	update_text();
	update_node_classes();
}

update_shortest_paths();

var simulation_history = [];
d3.select(window).on('keydown', function() {
	d3.event.preventDefault();
	
	//console.log(d3.event.keyCode)

	if (d3.event.keyCode == 39) { // right arrow 
		if (has_guys_away_from_exit()) {
			simulation_history.push(move_guys_to_exit());
		}

	}
	if (d3.event.keyCode == 37) { // left arrow 

		if (simulation_history.length > 0) {
			var types = simulation_history.pop();

			n('*').each((d, i) => d.node_type = types[i]);
			
			update_node_classes();
		}
	}
	if (d3.event.keyCode == 69) { // 'e' is the delete key

		if (lastSelected) {
			delete_node(lastSelected.datum())
			lastSelected = null;
		}			
	}
})

n('*').select('circle').on('click', function(d) { 
	// cycle through empty, guy, deleted, empty, etc.
	var types = ['empty', 'guy', 'deleted'];
	
	var cur_index = types.indexOf(d.node_type);
	cur_index++;

	var new_type = types[cur_index % types.length];
	d.node_type = new_type; 

	if (new_type == 'deleted') {
		
		// TODO: convert to event broadcast / listener model
		update_shortest_paths();
	}


	update_node_classes();
	lastSelected = d3.select(this);
})

// demo stuff


</script>
</body>
